<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"   "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="defaultsetting">

	<select id="selectTcPrdInfoList" parameterClass="string" resultClass="hmap">
		<![CDATA[
		SELECT PRD_SE, PRD_NM, PRD_ENG_NM FROM $dbUser$TC_PRD_INFO
		ORDER BY PRD_SN
		]]>
	</select>

	<!-- 통계표담당자,공표구분에 따른 주기 -->
	<sql id="selectPeriodPubSe">
		<![CDATA[
			AND B.PRD_DE BETWEEN
            CASE
                WHEN A.STRT_RSTR_DE IS NOT NULL AND A.STRT_RLS_DE IS NOT NULL AND SYSDATE < A.STRT_RLS_DE THEN
                    CASE
                        WHEN A.STRT_RSTR_DE < (SELECT MIN(PRD_DE) FROM $dbUser$TN_RECD_PRD WHERE ORG_ID = A.ORG_ID AND TBL_ID = A.TBL_ID AND PRD_SE = A.PRD_SE AND PRD_DE BETWEEN A.STRT_PRD_DE AND A.END_PRD_DE AND PUB_SE
                        ]]>
                        <include refid="common.pub_se"/>
						<![CDATA[
                        ) THEN
                            (SELECT MIN(PRD_DE) FROM $dbUser$TN_RECD_PRD WHERE ORG_ID = A.ORG_ID AND TBL_ID = A.TBL_ID AND PRD_SE = A.PRD_SE AND PRD_DE BETWEEN A.STRT_PRD_DE AND A.END_PRD_DE AND PUB_SE
                            ]]>
                            <include refid="common.pub_se"/>
							<![CDATA[
                            )
                        ELSE A.STRT_RSTR_DE
                    END
                ELSE
                    (SELECT MIN(PRD_DE) FROM $dbUser$TN_RECD_PRD WHERE ORG_ID = A.ORG_ID AND TBL_ID = A.TBL_ID AND PRD_SE = A.PRD_SE AND PRD_DE BETWEEN A.STRT_PRD_DE AND A.END_PRD_DE AND PUB_SE
                    ]]>
                    <include refid="common.pub_se"/>
					<![CDATA[
                    )
            END
            AND
            CASE
                WHEN A.END_RSTR_DE IS NOT NULL AND A.END_RLS_DE IS NOT NULL AND SYSDATE < A.END_RLS_DE THEN
                    CASE
                        WHEN A.END_RSTR_DE > (SELECT MAX(PRD_DE) FROM $dbUser$TN_RECD_PRD WHERE ORG_ID = A.ORG_ID AND TBL_ID = A.TBL_ID AND PRD_SE = A.PRD_SE AND PRD_DE BETWEEN A.STRT_PRD_DE AND A.END_PRD_DE AND PUB_SE
                        ]]>
                        <include refid="common.pub_se"/>
						<![CDATA[
                        ) THEN
                            (SELECT MAX(PRD_DE) FROM $dbUser$TN_RECD_PRD WHERE ORG_ID = A.ORG_ID AND TBL_ID = A.TBL_ID AND PRD_SE = A.PRD_SE AND PRD_DE BETWEEN A.STRT_PRD_DE AND A.END_PRD_DE AND PUB_SE
                            ]]>
                            <include refid="common.pub_se"/>
						<![CDATA[
                            )
                        ELSE A.END_RSTR_DE
                    END
                ELSE
                    (SELECT MAX(PRD_DE) FROM $dbUser$TN_RECD_PRD WHERE ORG_ID = A.ORG_ID AND TBL_ID = A.TBL_ID AND PRD_SE = A.PRD_SE AND PRD_DE BETWEEN A.STRT_PRD_DE AND A.END_PRD_DE AND PUB_SE
                    ]]>
                    <include refid="common.pub_se"/>
					<![CDATA[
                    )
            END
		]]>
	</sql>

	<!-- 20.04.09 업무용에서 담당자가 st 파라미터를 이용하여 서비스용으로 조회할때 원래 serverType은 관리자 였으므로 기간보안 체크안함
		(손상호 주무관의 요청에 따라 [미리보는KOSIS]에서는 기간보안 체크안함.
	 -->
	<select id="selectDefaultPeriod" parameterClass="param" resultClass="string">
		<![CDATA[
		SELECT PRD_SE
		FROM
		(
			SELECT 	DISTINCT B.PRD_SE, C.PRD_SN
			FROM 	$dbUser$TN_STBL_RECD_INFO A, $dbUser$TN_RECD_PRD B, $dbUser$TC_PRD_INFO  C
				WHERE 	A.ORG_ID = #orgId# AND A.TBL_ID = #tblId#
						AND A.ORG_ID = B.ORG_ID AND A.TBL_ID = B.TBL_ID
   					AND A.PUB_SE
   					 ]]>
   					<include refid="common.pub_se"/>
   					<![CDATA[
						AND A.PRD_SE = B.PRD_SE
						AND A.PRD_SE = C.PRD_SE
					]]>
					<isNotEqual property="serverType" compareValue="stat_emp">
						<isNotEqual property="serverTypeOrigin" compareValue="stat_emp">
							<include refid="selectPeriodPubSe"/>
						</isNotEqual>
					</isNotEqual>
					<![CDATA[
                       AND B.PUB_SE
                        ]]>
   					<include refid="common.pub_se"/>
   					<![CDATA[
			ORDER BY C.PRD_SN
		)
		WHERE ROWNUM = 1
		]]>
	</select>

	<!-- TN_STBL_SCR 가져오기(대표화면) -->
	<select id="selectScrInfo" parameterClass="param" resultClass="hmap">
		<![CDATA[
		SELECT 	ARRY_SE, CODE, MAX(COLNAME) AS COLNAME, MAX(ARRY_SN) AS ARRY_SN
		FROM 	$dbUser$TN_STBL_SCR
		WHERE 	ORG_ID = #orgId# AND TBL_ID = #tblId#
				AND SCR_PK_AT = 'Y'
				AND (COLNAME = 'measure_cd' OR COLNAME='prd_de' OR COLNAME LIKE 'dim%')
				AND ARRY_SE != '0'
		GROUP BY ARRY_SE, CODE
		ORDER BY ARRY_SE, ARRY_SN
		]]>
	</select>

	<!-- TN_STBL_SCR 가져오기(scrId 받아온경우) -->
	<select id="selectScrInfoUsingScrId" parameterClass="map" resultClass="hmap">
		<![CDATA[
		SELECT 	ARRY_SE, CODE, MAX(COLNAME) AS COLNAME, MAX(ARRY_SN) AS ARRY_SN, MAX(FUNC) AS FUNC
		FROM 	$dbUser$$tnStblScr$
		WHERE 	ORG_ID = #orgId# AND TBL_ID = #tblId#
				AND SCR_ID = #scrId#
				AND EMP_ID = #empId#
				AND (COLNAME = 'measure_cd' OR COLNAME='prd_de' OR COLNAME LIKE 'dim%')
				AND ARRY_SE != '0'
		GROUP BY ARRY_SE, CODE
		ORDER BY ARRY_SE, ARRY_SN
		]]>
	</select>

	<select id="selectScrParam" parameterClass="map" resultClass="string">
		<![CDATA[
		SELECT 	PARAM
		FROM 	$dbUser$$tnStblScr$
		WHERE 	ORG_ID = #orgId#
				AND TBL_ID = #tblId#
				AND SCR_ID = #scrId#
				AND EMP_ID = #empId#
				AND COLNAME = #colName#
		]]>
	</select>

	<select id="selectScrParamWeb" parameterClass="map" resultClass="string">
		<![CDATA[
		SELECT 	PARAM_WEB
		FROM 	$dbUser$$tnStblScr$
		WHERE 	ORG_ID = #orgId#
				AND TBL_ID = #tblId#
				AND SCR_ID = #scrId#
				AND EMP_ID = #empId#
				AND COLNAME = #colName#
		]]>
	</select>

	<select id="selectScrItmCount" parameterClass="map" resultClass="int">
		<![CDATA[
		SELECT	COUNT(1)
		FROM 	$dbUser$$tnStblScrItm$
		WHERE 	ORG_ID = #orgId#
				AND TBL_ID = #tblId#
				AND SCR_ID = #scrId#
				AND EMP_ID = #empId#
		]]>
	</select>

	<!-- ######################################################################################################
		분류 레벨의 분류값 가져오는 쿼리 시작 (egovMap 과 hmap '_' 변환으로 인한 조건절 2개
	###################################################################################################### -->
	<sql id="selectClassItem_withClause">
		<![CDATA[
		WITH ITM_LIST AS
       	(
       		SELECT ITM_ID, UP_ITM_ID, CHAR_ITM_SN
           	FROM $dbUser$TN_ITM_LIST
           	WHERE ORG_ID = #orgId# AND TBL_ID = #tblId# AND OBJ_VAR_ID = #objVarId#
		]]>
           	 
           	<isNotEmpty property="itm_id">
                <isEqual property="lv2" compareValue="N">
                	AND ITM_ID = #itm_id#
                </isEqual>
                <isEqual property="lv2" compareValue="Y">
                	AND (ITM_ID = #itm_id# OR UP_ITM_ID = #itm_id#)
                </isEqual>
            </isNotEmpty>
            <isNotEmpty property="itmId">
            	AND ITM_ID = #itmId#
            </isNotEmpty>
            
            <isEqual property="totIgnrAt" compareValue="Y">
                AND  NVL(FTN_VAL_AT, 'N') != 'Y'
            </isEqual>
         <![CDATA[
   			AND PUB_SE
   			]]>
   			<include refid="common.pub_se"/>
   		<![CDATA[
    		)
     	]]>
	</sql>

	<sql id="selectClassItem_mainClause">
		<![CDATA[
		SELECT	LEVEL LVL, ITM_ID, ROWNUM
        FROM 	ITM_LIST
        ]]>
        <isEqual property="levelCondition" compareValue="-1">
        	<![CDATA[ WHERE 	LEVEL <= #level# ]]>
        </isEqual>
        <isEqual property="levelCondition" compareValue="0">
           	<![CDATA[ WHERE 	LEVEL = #level# ]]>
        </isEqual>
        <isEqual property="levelCondition" compareValue="1">
           	<![CDATA[ WHERE 	LEVEL >= #level# ]]>
        </isEqual>
        <![CDATA[
   		START WITH UP_ITM_ID IS NULL
   		CONNECT BY PRIOR ITM_ID = UP_ITM_ID
   		ORDER SIBLINGS BY CHAR_ITM_SN, ITM_ID
   		]]>
	</sql>

	<!-- 마이스크랩으로 넘어오는 경우 -->
	<sql id="selectClassItem_mainClause_scrap">
		<![CDATA[
		SELECT	LEVEL LVL, ITM_ID, ROWNUM
        FROM 	ITM_LIST
        WHERE 	ITM_ID IN (
            		SELECT	ITM_ID
            		FROM 	$dbUser$$tnStblScrItm$
            		WHERE 	ORG_ID = #orgId#
            				AND TBL_ID = #tblId#
            				AND OBJ_VAR_ID = #objVarId#
                    		AND EMP_ID = #empId#
                    		AND SCR_ID = #scrId#
           		)
   		START WITH UP_ITM_ID IS NULL
   		CONNECT BY PRIOR ITM_ID = UP_ITM_ID
   		ORDER SIBLINGS BY CHAR_ITM_SN, ITM_ID
   		]]>
	</sql>

	<sql id="selectClassMaxLevel_mainClause">
		<![CDATA[
		SELECT	LEVEL LVL
        FROM 	ITM_LIST
   		START WITH UP_ITM_ID IS NULL
   		CONNECT BY PRIOR ITM_ID = UP_ITM_ID
     	]]>
	</sql>

	<!-- 분류의 max level -->
	<select id="selectMaxLevel" parameterClass="map" resultClass="int">
		<include refid="selectClassItem_withClause"/>
		<![CDATA[
			SELECT MAX(LVL) AS MAXLEVEL FROM (
		]]>
		<include refid="selectClassMaxLevel_mainClause"/>
		<![CDATA[
			)
		]]>
	</select>

	<!-- 분류값 수 -->
	<select id="selectLevelCnt" parameterClass="map" resultClass="int">
		<include refid="selectClassItem_withClause"/>
		<![CDATA[
		SELECT COUNT(*) FROM (
		]]>
		<include refid="selectClassItem_mainClause"/>
		<![CDATA[
		)
		]]>
	</select>

	<!-- 분류값 전체 -->
	<select id="selectClassItemListAll" parameterClass="map" resultClass="hmap">
		<include refid="selectClassItem_withClause"/>
		<include refid="selectClassItem_mainClause"/>
	</select>

	<!-- 분류값 마이스크랩 -->
	<select id="selectClassItemListScrap" parameterClass="map" resultClass="hmap">
		<include refid="selectClassItem_withClause"/>
		<include refid="selectClassItem_mainClause_scrap"/>
	</select>

	<!-- 분류값 건수 제한 -->
	<select id="selectClassItemListLimited" parameterClass="map" resultClass="hmap">
		<include refid="selectClassItem_withClause"/>
		<![CDATA[
		SELECT * FROM (
		]]>
		<include refid="selectClassItem_mainClause"/>
		<![CDATA[
		) WHERE ROWNUM <= #maxCnt#
		]]>
	</select>

	<!-- 비공개인 분류의 함수값 여부가 'Y'인 분류값 가져오기 -->
	<select id="selectClassItemListUnvisible" parameterClass="map" resultClass="string">
		<![CDATA[
		SELECT 	ITM_ID
		FROM 	$dbUser$TN_ITM_LIST
		WHERE	ORG_ID = #orgId# AND TBL_ID = #tblId#
				AND OBJ_VAR_ID = #objVarId#
				AND FTN_VAL_AT = 'Y'
		]]>
	</select>

	<!-- ######################################################################################################
		분류 레벨의 분류값 가져오는 쿼리 끝
	###################################################################################################### -->

	<!-- 항목 가져오기 -->
	<sql id="selectItem_mainClause">
		<![CDATA[
		SELECT	ITM_ID FROM $dbUser$TN_ITM_LIST
		WHERE 	ORG_ID = #orgId# AND TBL_ID = #tblId#
				AND OBJ_VAR_ID = '13999001'
				AND PUB_SE
				]]>
    			<include refid="common.pub_se"/>
    			<![CDATA[
		ORDER BY CHAR_ITM_SN, ITM_ID
     	]]>
	</sql>

	<select id="selectItemListAll" parameterClass="map" resultClass="hmap">
		<include refid="selectItem_mainClause"/>
	</select>

	<select id="selectItemListLimited" parameterClass="map" resultClass="hmap">
		<![CDATA[
		SELECT ITM_ID FROM (
		]]>
			<include refid="selectItem_mainClause"/>
		<![CDATA[
		) WHERE ROWNUM <= #maxCnt#
		]]>
	</select>

	<!-- 항목 가져오기 (마이스크랩) -->
	<select id="selectItemListScrap" parameterClass="map" resultClass="hmap">
		<![CDATA[
		SELECT	B.ITM_ID
		FROM 	$dbUser$$tnStblScrItm$ A, $dbUser$TN_ITM_LIST B
		WHERE  	A.ORG_ID = #orgId#
				AND A.TBL_ID = #tblId#
				AND A.OBJ_VAR_ID = '13999001'
	            AND A.ORG_ID = B.ORG_ID
	            AND A.TBL_ID = B.TBL_ID
	            AND A.OBJ_VAR_ID = B.OBJ_VAR_ID
	            AND A.ITM_ID = B.ITM_ID
	            AND A.EMP_ID = #empId#
	            AND A.SCR_ID = #scrId#
	            AND B.PUB_SE
       	]]>
       			<include refid="common.pub_se"/>
		<![CDATA[
		ORDER BY B.CHAR_ITM_SN, B.ITM_ID
     	]]>
	</select>

	<!-- 특정 주기의 시점 가져오기 -->
	<sql id="selectPeriodList_mainClause">
		<![CDATA[
		SELECT 	PRD_DE
		FROM 	$dbUser$TN_RECD_PRD
		WHERE 	ORG_ID = #orgId# AND TBL_ID = #tblId#
				AND PRD_SE = #prdSe#
				AND PRD_DE BETWEEN #minDe# AND #maxDe#
		]]>
			<isNotEmpty property="scrapMinDe">
				AND PRD_DE BETWEEN #scrapMinDe# AND #scrapMaxDe#
			</isNotEmpty>
		<![CDATA[
				AND PUB_SE
		]]>
		<include refid="common.pub_se"/>
		<![CDATA[
		ORDER BY PRD_DE DESC
     	]]>
	</sql>

	<select id="selectPeriodList" parameterClass="map" resultClass="hmap">
		<![CDATA[
		SELECT PRD_DE FROM (
		]]>
			<include refid="selectPeriodList_mainClause"/>
		<![CDATA[
		)
		]]>
		<isNotEmpty property="periodCnt">
			<![CDATA[
			WHERE ROWNUM <= #periodCnt#
			]]>
		</isNotEmpty>
	</select>

</sqlMap>