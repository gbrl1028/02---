<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"   "http://ibatis.apache.org/dtd/sql-map-2.dtd">   

<sqlMap namespace="log">

	<!-- log_seq 가져오기 -->
	<select id="selectLogSeqForNsoService" resultClass="string">
		<![CDATA[
		SELECT $useSeq$.NEXTVAL||'' FROM DUAL
		]]>
	</select>
	
	<select id="selectChkCnt" resultClass="int">
		<![CDATA[
		SELECT	COUNT(*) AS CNT 
		FROM 	$useLogCode$
		WHERE 	LEV_1_CD||LEV_2_CD = #connPath#
		]]>
	</select>
	
	<select id="selectConnPath" resultClass="String">
		<![CDATA[
		SELECT	LEV_1_CD||LEV_2_CD AS CONN_PATH
		FROM 	$useLogCode$
		WHERE 	VW_CD = #connPath#
		]]>
	</select>
	
	<!-- 2016.08.16 통합로그인 사용자의 이름도 가져올 수 있도록 수정 - 김경호 -->
	<!-- 2017.11.02 통합로그인으로 회원정보 일원화 EKP.USR 테이블은 사용하지 않도록 수정하고 휴면계정 테이블(TN_ITGR_USER_DORMANCY) 추가  - 김경호 -->
	<select id="selectEmpNmForNsoService" parameterClass="string" resultClass="String">
		<![CDATA[
		SELECT * FROM (
			SELECT USR_NAME     
			FROM EKP.TN_ITGR_USER
			WHERE USR_ID = #EMPID#
			UNION
			SELECT    USR_NAME     
            FROM     EKP.TN_ITGR_USER_DORMANCY
            WHERE    USR_ID = #EMPID#
		) WHERE ROWNUM = 1     
		]]>
	</select>
	
	<select id="selectEmpNmForNsoStat" parameterClass="map" resultClass="String">
		<![CDATA[
		SELECT	EMP_NM
		FROM 	$dbUser$TN_EMP
		WHERE	EMP_ID = #empId#
		]]>
	</select>
	
	<insert id="insertUseLogForNsoService" parameterClass="map">
		<![CDATA[
		INSERT INTO $useLog$ (	
			LOG_SEQ, FIRST_YN, USE_DATE, IP_ADDR
			, ORG_ID, TBL_ID
			, PUB, VIEW_SE, USE_ANAL, CONN_PATH, VIEW_PERIOD, VIEW_KIND, VIEW_SUB_KIND
			, STAT_KIND
			, USR_ID, USR_NM
			, STAT_ID
			, REL_ORG_ID
			, REL_TBL_ID
		) VALUES (
			#logSeq#, #firstYn#, SYSDATE, #ipAddr#
			, #orgId#, #tblId#
			, #pub#, #viewSe#, #useAnal#, #connPath#, #viewPeriod#, #viewKind#, #viewSubKind#
			, #statKind#
			, #usrId#, #usrNm#
			, #statId#
			, #relChkOrgId#
			, #relChkTblId#
		)
		]]>
	</insert>
	
	<insert id="insertUseLogInterceptForNsoService" parameterClass="map">
		<![CDATA[
		INSERT INTO $useLogIntercept$ (	
			INTERCEPT_DATE
			, ORG_ID, TBL_ID
			, PRD_SE, STRT_PRD_DE, END_PRD_DE
			, IP_ADDR
			, BEFORE_PAGE
		) VALUES (
			SYSDATE
			, #orgId#, #tblId#
			, #prdSe#, #strtPrdDe#, #endPrdDe#
			, #ipAddr#
			, #beforePage#
		)
		]]>
	</insert>
	
	<insert id="insertUseLogForStatNso" parameterClass="map">
		<![CDATA[
		INSERT INTO $useLog$ (	
			ORG_ID, TBL_ID
			, EMP_ID, SDATE
			, PUB_SE, VIEW_SE, IPADD
			, CUR_EMP_NM
			, REL_ORG_ID
			, REL_TBL_ID
		) VALUES (
			#orgId#, #tblId#
			, #empId#, SYSDATE
			, #pubSe#, #viewSe#, #ipAdd#
			, #curEmpNm#
			, #relChkOrgId#
			, #relChkTblId#
		)
		]]>
	</insert>
	
	<update id="updateUseLogForHostingNSply" parameterClass="map">
		<![CDATA[
		UPDATE	$dbUser$$useLog$ SET $columnName$ = $columnName$ + 1
		WHERE	YEAR = #year# AND MONTH = #month#
				AND TBL_ID = #tblId# AND ORG_ID = #orgId#
				AND VW_CD = #vwCd# AND LIST_ID = #listId#
				AND V_TYPE = #vType#
				AND REL_ORG_ID = #relChkOrgId# AND REL_TBL_ID = #relChkTblId#
		]]>
	</update>
	
	<insert id="insertUseLogForHostingNSply" parameterClass="map">
		<![CDATA[
		INSERT INTO	$dbUser$$useLog$ (
			YEAR, MONTH
			, TBL_ID, ORG_ID
			, $columnName$
			, VW_CD, LIST_ID
			, V_TYPE
			, REL_ORG_ID
			, REL_TBL_ID
		) VALUES (
			#year#, #month#
			, #tblId#, #orgId#
			, 1
			, #vwCd#, #listId#
			, #vType#
			, #relChkOrgId#
			, #relChkTblId#
		)			
		]]>
	</insert>
	
	<update id="updateOlapLog" parameterClass="map">
		<![CDATA[
		UPDATE	$olapLog$ SET $columnName$ = $columnName$ + 1
		WHERE	YEAR = #year# AND MONTH = #month#
				AND TBL_ID = #tblId# AND ORG_ID = #orgId#
				AND VW_CD = #vwCd# AND LIST_ID = #listId#
				AND V_TYPE = #vType#
		]]>
	</update>
	
	<insert id="insertOlapLog" parameterClass="map">
		<![CDATA[
		INSERT INTO	$olapLog$ (
			YEAR, MONTH
			, TBL_ID, ORG_ID
			, $columnName$
			, VW_CD, LIST_ID
			, V_TYPE
			, REL_ORG_ID
			, REL_TBL_ID
		) VALUES (
			#year#, #month#
			, #tblId#, #orgId#
			, 1
			, #vwCd#, #listId#
			, #vType#
			, #relChkOrgId#
			, #relChkTblId#
		)			
		]]>
	</insert>
	
	<insert id="insertUseLogForDirect" parameterClass="map">
		<![CDATA[
		 INSERT INTO $useLog$ (    
           log_Seq, FIRST_YN, USE_DATE, IP_ADDR
            , ORG_ID, TBL_ID
            , PUB, VIEW_SE, USE_ANAL, CONN_PATH, VIEW_PERIOD, VIEW_KIND, VIEW_SUB_KIND
            , STAT_KIND
            , USR_ID, USR_NM
            , STAT_ID
        ) VALUES (
            $useSeq$.NEXTVAL, 'Y', SYSDATE, #ipAddr#
            , #orgId#, #tblId#
            , (select substr(pub_se, -1) from $dbUser$tn_Stbl_info where org_id = #orgId# and tbl_id = #tblId#), '5', '',#connPath#, #viewPeriod#, '2', #viewSubKind#
            , #statKind#
            , #usrId#, #usrNm#
            , (SELECT STAT_ID FROM $dbUser$TN_STBL_INFO WHERE ORG_ID = #orgId# AND TBL_ID = #tblId#)
        )
        ]]>
	</insert>

</sqlMap>